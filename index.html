<!DOCTYPE html>
<html data-theme="light">
<head>
    <title>KirixGPT</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Мета-теги для предпросмотра на английском -->
    <meta name="description" content="KirixGPT - AI assistant powered by Claude 3.7 Sonnet">
    <meta property="og:title" content="KirixGPT">
    <meta property="og:description" content="Powerful AI assistant for your everyday tasks">
    <meta property="og:image" content="https://ai.kirixsocial.com/preview.jpg">
    <meta property="og:url" content="https://ai.kirixsocial.com">
    <meta property="og:type" content="website">
    
    <!-- Мета-теги для предпросмотра на украинском -->
    <meta property="og:locale:alternate" content="uk_UA">
    <meta property="og:title:uk" content="KirixGPT">
    <meta property="og:description:uk" content="Потужний ШІ-асистент для ваших повсякденних завдань">

    <link rel="icon" href="/static/icon.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        :root[data-theme="light"] {
            --bg-color: #ffffff;
            --chat-bg: #f8f9fa;
            --text-color: #2c3e50;
            --secondary-text: #6c757d;
            --border-color: #dee2e6;
            --input-bg: #ffffff;
            --message-bg: #ffffff;
            --user-message-bg: #f8f9fa;
            --button-bg: #4a5568;
            --button-hover: #2d3748;
            --tool-button-bg: #f8f9fa;
            --tool-button-color: #4a5568;
            --loading-color: #6c757d;
            --header-bg: rgba(255, 255, 255, 0.9);
            --header-border: #dee2e6;
            --gradient-start: #4a5568;
            --gradient-end: #718096;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --input-shadow: rgba(0, 0, 0, 0.03);
            --error-color: #e53e3e;
            --success-color: #38a169;
            --info-color: #3182ce;
        }

        :root[data-theme="dark"] {
            --bg-color: #1a202c;
            --chat-bg: #1a202c;
            --text-color: #e2e8f0;
            --secondary-text: #a0aec0;
            --border-color: #2d3748;
            --input-bg: #2d3748;
            --message-bg: #2d3748;
            --user-message-bg: #283141;
            --button-bg: #4a5568;
            --button-hover: #718096;
            --tool-button-bg: #2d3748;
            --tool-button-color: #e2e8f0;
            --loading-color: #a0aec0;
            --header-bg: rgba(26, 32, 44, 0.9);
            --header-border: #2d3748;
            --gradient-start: #4a5568;
            --gradient-end: #718096;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --input-shadow: rgba(0, 0, 0, 0.1);
            --error-color: #fc8181;
            --success-color: #68d391;
            --info-color: #63b3ed;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes typing {
            0% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 0.3; transform: scale(0.8); }
        }

        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes cursorBlink {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        @keyframes introAnimation {
            0% {
                opacity: 0;
                transform: scale(8);
            }
            15% {
                opacity: 1;
                transform: scale(8);
            }
            60% {
                transform: scale(0.6);
                opacity: 1;
            }
            80% {
                transform: scale(1);
                opacity: 0.8;
            }
            100% {
                opacity: 0;
                transform: scale(1.2);
            }
        }

        @keyframes fadeInContent {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            0% {
                opacity: 1;
                visibility: visible;
            }
            100% {
                opacity: 0;
                visibility: hidden;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            overflow-y: auto;
        }

        body.has-overlay {
            overflow: hidden;
        }

        .intro-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeOut 1.5s ease 2s forwards;
            overflow: hidden;
        }

        .intro-logo {
            font-size: 96px;
            font-weight: 700;
            background: linear-gradient(90deg, 
                var(--gradient-start), 
                var(--gradient-end));
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: introAnimation 2s ease-in-out forwards;
            white-space: nowrap;
        }

        .main-content {
            opacity: 0;
            animation: fadeInContent 0.5s ease 1.5s forwards;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: transparent;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(8px);
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(
                90deg,
                transparent,
                var(--border-color),
                var(--border-color),
                var(--border-color),
                transparent
            );
            opacity: 0.5;
        }

        .header-title {
            font-size: 22px;
            font-weight: 600;
            background: linear-gradient(90deg, 
                var(--gradient-start), 
                var(--gradient-end));
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: shimmer 6s linear infinite;
            position: relative;
        }

        .header-controls {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .auth-buttons {
            position: relative;
        }

        .auth-status {
            color: var(--secondary-text);
            font-size: 14px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auth-status:hover {
            background-color: var(--tool-button-bg);
        }

        .auth-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--message-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px;
            margin-top: 8px;
            box-shadow: 0 4px 12px var(--shadow-color);
            display: none;
            min-width: 200px;
            z-index: 1000;
        }

        .auth-dropdown.show {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        .auth-dropdown-header {
            padding: 8px 16px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .auth-dropdown-item {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-color);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .auth-dropdown-item:hover {
            background-color: var(--tool-button-bg);
        }

        .logged-in {
            color: var(--success-color);
        }

        #signIn {
            background: none;
            border: none;
            color: var(--text-color);
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        #signIn:hover {
            background-color: var(--tool-button-bg);
        }

        .theme-toggle {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 22px;
            padding: 8px;
            color: var(--secondary-text);
            transition: transform 0.5s ease;
            border-radius: 50%;
        }

        .theme-toggle:hover {
            transform: rotate(180deg);
            background-color: var(--tool-button-bg);
        }

        .container {
            max-width: 1000px;
            margin: 60px auto 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 80px);
        }

        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 12px;
            background-color: var(--chat-bg);
            scrollbar-width: none;
            -ms-overflow-style: none;
            position: relative;
        }

        .chat-container::-webkit-scrollbar {
            display: none;
        }

        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: transparent;
            padding: 20px;
            backdrop-filter: blur(8px);
            z-index: 1000;
        }

        .input-wrapper {
            max-width: 1000px;
            margin: 0 auto;
            position: relative;
            padding: 0 20px;
        }

        .input-group {
            display: flex;
            gap: 12px;
            align-items: center;
            background-color: var(--input-bg);
            border-radius: 24px;
            padding: 8px 8px 8px 20px;
            box-shadow: 0 2px 15px var(--shadow-color);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(8px);
            background: rgba(255, 255, 255, 0.7);
        }

        :root[data-theme="dark"] .input-group {
            background: rgba(45, 55, 72, 0.7);
        }

        input[type="text"] {
            flex-grow: 1;
            background-color: transparent;
            border: none;
            color: var(--text-color);
            font-size: 15px;
            padding: 8px;
            outline: none;
            min-height: 24px;
            line-height: 24px;
        }

        input[type="text"]::placeholder {
            color: var(--secondary-text);
        }

        #attachFile {
            background-color: transparent;
            border: none;
            color: var(--secondary-text);
            padding: 8px;
            font-size: 16px;
            border-radius: 50%;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            margin-right: auto;
        }

        #attachFile:hover {
            background-color: var(--tool-button-bg);
            color: var(--text-color);
        }

        #sendMessage {
            background-color: var(--button-bg);
            border: none;
            padding: 8px;
            color: white;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        #sendMessage:not(:disabled):hover {
            background-color: var(--button-hover);
            transform: scale(1.05);
        }

        #sendMessage:disabled {
            background-color: var(--button-bg);
            opacity: 0.5;
            cursor: not-allowed;
        }

        #sendMessage i {
            font-size: 16px;
        }

        .tools {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
            z-index: 1001;
        }

        #clearChat {
            background-color: transparent;
            border: none;
            color: var(--secondary-text);
            padding: 8px;
            font-size: 16px;
            border-radius: 50%;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        #clearChat:hover {
            background-color: var(--tool-button-bg);
            color: var(--text-color);
        }

        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }

        .message-header {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            opacity: 0.8;
        }

        .message-content {
            color: var(--text-color);
            line-height: 1.6;
            font-size: 15px;
            padding: 16px;
            border-radius: 12px;
            background-color: var(--message-bg);
            box-shadow: 0 1px 4px var(--shadow-color);
            border: 1px solid var(--border-color);
            max-width: 80%;
            position: relative;
        }

        .message.user .message-content {
            background-color: var(--user-message-bg);
            margin-left: auto;
        }

        .message:not(.user) .message-content {
            margin-right: auto;
        }

        /* Стили для форматированного текста */
        .message-content code {
            background-color: var(--tool-button-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 0.9em;
        }

        .message-content pre {
            background-color: var(--tool-button-bg);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 8px 0;
            position: relative;
            padding-top: 40px;
            border: 1px solid var(--border-color);
        }

        .message-content pre code {
            background-color: transparent;
            padding: 0;
            display: block;
        }

        .message-content strong {
            font-weight: 600;
            color: var(--text-color);
        }

        .message-content em {
            font-style: italic;
            color: var(--text-color);
        }

        .message-content blockquote {
            border-left: 4px solid var(--border-color);
            margin: 8px 0;
            padding-left: 12px;
            color: var(--secondary-text);
        }

        .message-content ul, .message-content ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        .message-content li {
            margin: 4px 0;
        }

        .message-content a {
            color: var(--info-color);
            text-decoration: none;
        }

        .message-content a:hover {
            text-decoration: underline;
        }

        .message-content h1, .message-content h2, .message-content h3, 
        .message-content h4, .message-content h5, .message-content h6 {
            margin: 16px 0 8px;
            font-weight: 600;
        }

        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 8px 0;
        }

        .message-content th, .message-content td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: left;
        }

        .message-content th {
            background-color: var(--tool-button-bg);
        }

        .copy-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: var(--tool-button-bg);
            border: none;
            color: var(--secondary-text);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .message-content:hover .copy-button {
            opacity: 1;
        }

        .copy-button:hover {
            background-color: var(--button-bg);
            color: var(--bg-color);
        }

        .copy-button i {
            font-size: 12px;
        }

        /* Стили для подсветки синтаксиса */
        .hljs-keyword { color: #c678dd; }
        .hljs-string { color: #98c379; }
        .hljs-comment { color: #5c6370; font-style: italic; }
        .hljs-function { color: #61afef; }
        .hljs-number { color: #d19a66; }
        .hljs-operator { color: #56b6c2; }
        .hljs-class { color: #e5c07b; }
        .hljs-variable { color: #e06c75; }

        .message.user {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .message.user .message-header {
            padding-right: 8px;
        }

        .message:not(.user) .message-header {
            padding-left: 8px;
        }

        .message.user .message-content {
            border-top-right-radius: 4px;
        }

        .message:not(.user) .message-content {
            border-top-left-radius: 4px;
        }

        .auth-status {
            color: var(--secondary-text);
            font-size: 14px;
            font-weight: 500;
        }

        .logged-in {
            color: #00cc88;
        }

        img {
            max-width: 100%;
            border-radius: 12px;
            margin-top: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        .loading {
            color: var(--loading-color);
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .typing-indicator {
            display: inline-flex;
            gap: 4px;
            margin-left: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--loading-color);
        }

        .typing-dot:nth-child(1) { animation: typing 1s infinite 0s; }
        .typing-dot:nth-child(2) { animation: typing 1s infinite 0.2s; }
        .typing-dot:nth-child(3) { animation: typing 1s infinite 0.4s; }

        .stream-chunk {
            display: inline;
            opacity: 0;
            animation: slideIn 0.5s ease forwards;
        }

        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1em;
            background-color: var(--text-color);
            margin-left: 2px;
            vertical-align: middle;
            animation: cursorBlink 0.8s infinite;
        }

        .typing-active .typing-cursor {
            display: inline-block;
        }

        .typing-done .typing-cursor {
            display: none;
        }

        .error-message {
            color: var(--error-color);
        }

        .success-message {
            color: var(--success-color);
        }

        .info-message {
            color: var(--info-color);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .input-group {
                flex-wrap: wrap;
            }
            
            .tools {
                width: 100%;
                justify-content: space-around;
                margin-top: 8px;
            }
        }

        .welcome-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            opacity: 0.8;
            transition: all 0.5s ease;
        }

        .welcome-message .message-content {
            background-color: transparent;
            border: none;
            box-shadow: none;
            font-size: 24px;
            font-weight: 500;
            color: var(--secondary-text);
            padding: 0;
            margin: 0;
            max-width: 100%;
        }

        .welcome-message .message-header {
            justify-content: center;
            margin-bottom: 16px;
        }

        .welcome-message i {
            font-size: 48px;
            margin-bottom: 16px;
            background: linear-gradient(90deg, 
                var(--gradient-start), 
                var(--gradient-end));
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: shimmer 6s linear infinite;
        }

        .welcome-message.hidden {
            opacity: 0;
            visibility: hidden;
            transform: translate(-50%, -60%);
        }

        .code-copy-button {
            position: relative;
            background-color: var(--button-bg);
            border: none;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
            opacity: 0.8;
        }

        .code-copy-button:hover {
            opacity: 1;
            transform: translateY(-1px);
            background-color: var(--button-hover);
        }

        .code-copy-button:active {
            transform: translateY(1px);
        }

        .code-copy-button i {
            font-size: 12px;
        }

        .code-language-label {
            position: relative;
            font-size: 12px;
            color: white;
            background-color: var(--button-bg);
            padding: 3px 8px;
            border-radius: 4px;
            opacity: 0.8;
            z-index: 100;
            font-weight: 500;
        }

        .code-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 36px;
            background-color: rgba(0, 0, 0, 0.3);
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 12px;
            z-index: 50;
        }
    </style>
</head>
<body>
    <div class="intro-overlay">
        <div class="intro-logo">KirixGPT</div>
    </div>
    <div class="main-content">
        <div class="header">
            <div class="header-title">KirixGPT</div>
            <div class="header-controls">
                <div class="language-selector">
                    <button class="lang-button" onclick="changeLanguage('uk')">UK</button>
                    <button class="lang-button" onclick="changeLanguage('en')">EN</button>
                </div>
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
                <div class="auth-buttons">
                    <div id="authStatus" class="auth-status logged-out" style="display: none;">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <button id="signIn" style="display: flex;">
                        <i class="fas fa-sign-in-alt"></i> Войти
                    </button>
                    <div class="auth-dropdown">
                        <div class="auth-dropdown-header">
                            <i class="fas fa-user"></i> <span id="userName"></span>
                        </div>
                        <div class="auth-dropdown-item" id="signOut">
                            <i class="fas fa-sign-out-alt"></i> Выйти
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="chat-container" id="chatContainer">
                <div class="message system welcome-message" id="welcomeMessage">
                    <div class="message-content">
                        <i class="fas fa-robot"></i>
                        <div>Чем я могу помочь?</div>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <div class="input-wrapper">
                    <div class="input-group">
                        <button class="tool-button" id="attachFile" title="Прикрепить файл">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <input type="text" id="userInput" placeholder="Спросите что-нибудь...">
                        <button id="sendMessage" disabled>
                            <i class="fas fa-arrow-up"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://js.puter.com/v2/"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const chatContainer = document.getElementById('chatContainer');
        const themeToggle = document.getElementById('themeToggle');
        let currentTheme = localStorage.getItem('theme') || 'light';
        
        // Массив для хранения истории сообщений
        let chatHistory = [];
        
        // Добавляем переводы для всех поддерживаемых языков
        const translations = {
            ru: {
                help: 'Чем я могу помочь?',
                placeholder: 'Спросите что-нибудь...',
                typing: 'Печатает',
                copy: 'Копировать',
                copied: 'Скопировано',
                clearHistory: 'Очистить историю',
                clearConfirm: 'Вы уверены, что хотите очистить историю чата?',
                you: 'Вы',
                signIn: 'Войти',
                signOut: 'Выйти',
                attachFile: 'Прикрепить файл',
                imageUploaded: 'Изображение загружено:',
                imagePasted: 'Изображение вставлено:',
                imageGeneration: 'Генерация изображения:',
                imageCreated: 'Изображение создано:',
                authRequired: 'Для загрузки файлов необходимо авторизоваться',
                error: 'Ошибка:',
                code: 'текст'
            },
            uk: {
                help: 'Чим я можу допомогти?',
                placeholder: 'Запитайте що-небудь...',
                typing: 'Друкує',
                copy: 'Копіювати',
                copied: 'Скопійовано',
                clearHistory: 'Очистити історію',
                clearConfirm: 'Ви впевнені, що хочете очистити історію чату?',
                you: 'Ви',
                signIn: 'Увійти',
                signOut: 'Вийти',
                attachFile: 'Прикріпити файл',
                imageUploaded: 'Зображення завантажено:',
                imagePasted: 'Зображення вставлено:',
                imageGeneration: 'Генерація зображення:',
                imageCreated: 'Зображення створено:',
                authRequired: 'Для завантаження файлів необхідно авторизуватися',
                error: 'Помилка:',
                code: 'текст'
            },
            en: {
                help: 'How can I help you?',
                placeholder: 'Ask something...',
                typing: 'Typing',
                copy: 'Copy',
                copied: 'Copied',
                clearHistory: 'Clear History',
                clearConfirm: 'Are you sure you want to clear chat history?',
                you: 'You',
                signIn: 'Sign In',
                signOut: 'Sign Out',
                attachFile: 'Attach File',
                imageUploaded: 'Image uploaded:',
                imagePasted: 'Image pasted:',
                imageGeneration: 'Image generation:',
                imageCreated: 'Image created:',
                authRequired: 'Authorization required to upload files',
                error: 'Error:',
                code: 'text'
            }
        };

        // Функция для определения языка браузера
        function getBrowserLanguage() {
            const lang = navigator.language.toLowerCase().split('-')[0];
            return translations[lang] ? lang : 'en';
        }

        // Проверяем URL на наличие параметра языка
        function checkUrlForLanguage() {
            const urlParams = new URLSearchParams(window.location.search);
            const langParam = urlParams.get('lang');
            
            if (langParam && translations[langParam]) {
                return langParam;
            }
            return null;
        }

        // Текущий язык интерфейса
        let currentLanguage = checkUrlForLanguage() || localStorage.getItem('language') || getBrowserLanguage();
        
        // Если текущий язык русский, но мы не находимся на странице с параметром ?lang=ru, перенаправляем
        if (currentLanguage === 'ru' && !window.location.search.includes('lang=ru')) {
            // Сохраняем выбор в localStorage, но не перенаправляем, если это первая загрузка
            if (localStorage.getItem('language') === 'ru') {
                const urlParams = new URLSearchParams(window.location.search);
                urlParams.set('lang', 'ru');
                window.location.search = urlParams.toString();
            } else {
                // Просто устанавливаем язык по умолчанию, если это первая загрузка
                currentLanguage = 'en';
            }
        }

        // Функция для изменения языка интерфейса
        function changeLanguage(lang) {
            if (!translations[lang]) return;
            
            // Если выбран русский язык, перенаправляем на страницу с параметром ?lang=ru
            if (lang === 'ru') {
                localStorage.setItem('language', lang);
                const urlParams = new URLSearchParams(window.location.search);
                urlParams.set('lang', 'ru');
                window.location.search = urlParams.toString();
                return;
            }
            
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            
            // Если мы были на странице с параметром ?lang=ru, но выбрали другой язык, убираем параметр из URL
            if (window.location.search.includes('lang=ru') && lang !== 'ru') {
                const urlParams = new URLSearchParams(window.location.search);
                urlParams.delete('lang');
                const newSearch = urlParams.toString();
                const newUrl = window.location.pathname + (newSearch ? '?' + newSearch : '');
                window.history.pushState({}, '', newUrl);
            }
            
            updateInterface();
        }

        // Функция для получения перевода
        function t(key) {
            return translations[currentLanguage][key] || translations['en'][key];
        }

        // Добавляем стили для языкового переключателя
        const styleSheet = document.createElement("style");
        styleSheet.textContent = `
            .language-selector {
                display: flex;
                gap: 8px;
                margin-right: 16px;
            }
            .lang-button {
                background: none;
                border: none;
                color: var(--secondary-text);
                padding: 4px 8px;
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            .lang-button:hover {
                background-color: var(--tool-button-bg);
                color: var(--text-color);
            }
            .lang-button.active {
                background-color: var(--button-bg);
                color: white;
            }
        `;
        document.head.appendChild(styleSheet);

        // Функция обновления интерфейса при смене языка
        function updateInterface() {
            // Обновляем все языковые кнопки
            document.querySelectorAll('.lang-button').forEach(button => {
                const lang = button.textContent.toLowerCase();
                button.classList.toggle('active', lang === currentLanguage);
            });

            // Обновляем плейсхолдер в поле ввода
            document.getElementById('userInput').placeholder = t('placeholder');

            // Обновляем приветственное сообщение
            const welcomeMessage = document.getElementById('welcomeMessage');
            if (welcomeMessage) {
                welcomeMessage.querySelector('.message-content div').textContent = t('help');
            }

            // Обновляем кнопку входа
            document.getElementById('signIn').innerHTML = `<i class="fas fa-sign-in-alt"></i> ${t('signIn')}`;

            // Обновляем кнопку выхода
            document.getElementById('signOut').innerHTML = `<i class="fas fa-sign-out-alt"></i> ${t('signOut')}`;

            // Обновляем заголовок кнопки прикрепления файла
            document.getElementById('attachFile').title = t('attachFile');

            // Обновляем все кнопки копирования
            document.querySelectorAll('.copy-button').forEach(button => {
                button.innerHTML = `<i class="fas fa-copy"></i> ${t('copy')}`;
            });

            // Обновляем все кнопки копирования кода
            document.querySelectorAll('.code-copy-button').forEach(button => {
                button.innerHTML = `<i class="fas fa-copy"></i> ${t('copy')}`;
            });
        }

        // Вызываем функцию обновления интерфейса при загрузке страницы
        document.addEventListener('DOMContentLoaded', updateInterface);

        // Загружаем историю чата из localStorage при загрузке страницы
        function loadChatHistory() {
            const savedHistory = localStorage.getItem('chatHistory');
            if (savedHistory) {
                try {
                    chatHistory = JSON.parse(savedHistory);
                    
                    // Отображаем сохраненные сообщения
                    chatHistory.forEach(message => {
                        if (message.role === 'user') {
                            addMessage(message.content, true, false);
                        } else if (message.role === 'assistant') {
                            addMessage(message.content, false, false);
                        }
                    });
                    
                    // Если есть история, скрываем приветственное сообщение
                    if (chatHistory.length > 0) {
                        const welcomeMessage = document.getElementById('welcomeMessage');
                        if (welcomeMessage) {
                            welcomeMessage.remove();
                        }
                    }
                } catch (e) {
                    console.error('Ошибка при загрузке истории чата:', e);
                    localStorage.removeItem('chatHistory');
                    chatHistory = [];
                }
            }
        }
        
        // Сохраняем историю чата в localStorage
        function saveChatHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        }
        
        // Добавляем сообщение в историю
        function addToHistory(content, isUser) {
            const role = isUser ? 'user' : 'assistant';
            chatHistory.push({
                role: role,
                content: content
            });
            saveChatHistory();
        }
        
        // Очистка истории чата
        function clearChatHistory() {
            chatHistory = [];
            localStorage.removeItem('chatHistory');
            chatContainer.innerHTML = '';
            
            // Добавляем приветственное сообщение
            const welcomeMessage = document.createElement('div');
            welcomeMessage.className = 'message system welcome-message';
            welcomeMessage.id = 'welcomeMessage';
            welcomeMessage.innerHTML = `
                <div class="message-content">
                    <i class="fas fa-robot"></i>
                    <div>Чем я могу помочь?</div>
                </div>
            `;
            chatContainer.appendChild(welcomeMessage);
        }
        
        function updateThemeIcon() {
            themeToggle.innerHTML = currentTheme === 'light' ? 
                '<i class="fas fa-moon"></i>' : 
                '<i class="fas fa-sun"></i>';
        }
        
        // Установка начальной темы
        document.documentElement.setAttribute('data-theme', currentTheme);
        updateThemeIcon();
        
        themeToggle.addEventListener('click', () => {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            updateThemeIcon();
        });

        function addMessage(content, isUser = false, saveToHistory = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : ''}`;
            
            const icon = isUser ? 
                '<i class="fas fa-user"></i>' : 
                '<i class="fas fa-robot"></i>';
            
            const header = `<div class="message-header">${icon} ${isUser ? t('you') : 'KirixGPT'}</div>`;
            
            // Настраиваем marked для использования highlight.js и добавления кнопки копирования
            marked.setOptions({
                highlight: function(code, lang) {
                    const language = lang && hljs.getLanguage(lang) ? lang : '';
                    const highlighted = language ? 
                        hljs.highlight(code, { language }).value : 
                        hljs.highlightAuto(code).value;
                        
                    return highlighted;
                },
                breaks: true
            });
            
            // Преобразуем Markdown в HTML, если это не пользовательское сообщение
            let processedContent = content;
            if (!isUser) {
                try {
                    processedContent = marked.parse(content);
                } catch (e) {
                    console.error('Ошибка при обработке Markdown:', e);
                }
            }
            
            const contentDiv = `<div class="message-content">
                ${processedContent}
                <button class="copy-button" onclick="copyMessageContent(this)">
                    <i class="fas fa-copy"></i> ${t('copy')}
                </button>
            </div>`;
            
            messageDiv.innerHTML = header + contentDiv;
            chatContainer.appendChild(messageDiv);
            
            // Обрабатываем блоки кода после добавления в DOM
            if (!isUser) {
                processCodeBlocks(messageDiv);
                
                // Активируем подсветку синтаксиса для всех блоков кода
                const codeBlocks = messageDiv.querySelectorAll('pre code');
                codeBlocks.forEach(block => {
                    hljs.highlightElement(block);
                });
            }
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Сохраняем сообщение в историю, если нужно
            if (saveToHistory) {
                addToHistory(content, isUser);
            }
            
            return messageDiv;
        }

        function createStreamChunk(text) {
            const span = document.createElement('span');
            span.className = 'stream-chunk';
            span.textContent = text;
            return span;
        }

        async function checkAuthStatus() {
            try {
                const isSignedIn = await puter.auth.isSignedIn();
                const authStatus = document.getElementById('authStatus');
                const signInButton = document.getElementById('signIn');
                
                if (isSignedIn) {
                    try {
                        const user = await puter.auth.getUser();
                        const userName = document.getElementById('userName');
                        
                        if (user && user.name !== 'undefined' && user.name !== undefined) {
                            authStatus.style.display = 'flex';
                            signInButton.style.display = 'none';
                            authStatus.className = 'auth-status logged-in';
                            userName.textContent = user.name;
                        } else {
                            authStatus.style.display = 'none';
                            signInButton.style.display = 'flex';
                        }
                    } catch (userError) {
                        console.error('Ошибка получения данных пользователя:', userError);
                        authStatus.style.display = 'none';
                        signInButton.style.display = 'flex';
                    }
                } else {
                    authStatus.style.display = 'none';
                    signInButton.style.display = 'flex';
                }
            } catch (error) {
                console.error('Ошибка проверки авторизации:', error);
                const authStatus = document.getElementById('authStatus');
                const signInButton = document.getElementById('signIn');
                authStatus.style.display = 'none';
                signInButton.style.display = 'flex';
            }
        }
        
        checkAuthStatus();

        // Обработка клика по иконке пользователя
        document.getElementById('authStatus').addEventListener('click', (e) => {
            const dropdown = document.querySelector('.auth-dropdown');
            dropdown.classList.toggle('show');
            e.stopPropagation();
        });

        // Закрытие выпадающего меню при клике вне его
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.auth-dropdown') && !e.target.closest('.auth-status')) {
                const dropdown = document.querySelector('.auth-dropdown');
                dropdown.classList.remove('show');
            }
        });

        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message';
            loadingDiv.innerHTML = `
                <div class="message-header">
                    <i class="fas fa-robot"></i> KirixGPT
                </div>
                <div class="message-content loading">
                    <i class="fas fa-pen"></i>
                    ${t('typing')}
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return loadingDiv;
        }

        async function streamResponse(prompt) {
            // Скрываем приветственное сообщение при первом вопросе
            const welcomeMessage = document.getElementById('welcomeMessage');
            if (welcomeMessage && !welcomeMessage.classList.contains('hidden')) {
                welcomeMessage.classList.add('hidden');
                // Удаляем его из DOM через 500мс (после анимации)
                setTimeout(() => {
                    welcomeMessage.remove();
                }, 500);
            }
            
            addMessage(prompt, true);
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            const icon = '<i class="fas fa-robot"></i>';
            const header = `<div class="message-header">${icon} KirixGPT</div>`;
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content typing-active';
            
            // Создаем контейнер для форматированного текста
            const formattedContainer = document.createElement('div');
            formattedContainer.className = 'formatted-content';
            
            // Добавляем курсор печатания
            const cursor = document.createElement('span');
            cursor.className = 'typing-cursor';
            
            messageDiv.innerHTML = header;
            messageDiv.appendChild(contentDiv);
            contentDiv.appendChild(formattedContainer);
            contentDiv.appendChild(cursor);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            try {
                const isSignedIn = await puter.auth.isSignedIn();
                
                // Создаем массив сообщений для API, включая историю
                const messages = [];
                
                // Добавляем системное сообщение
                messages.push({
                    role: 'system',
                    content: 'You are KirixGPT, a helpful assistant. Please adhere to the following principles in your responses:\n\n1. Structure information clearly and logically, using headings (##), subheadings (###), and nested lists.\n2. For complex topics, create detailed plans or step-by-step instructions with numbering and nested points.\n3. Use bullet points (- or *) for listing items and numbered lists (1., 2.) for sequential actions.\n4. Highlight key terms and important points using **bold text** and *italics* for emphasis.\n5. Divide large blocks of text into logical paragraphs for better readability, using empty lines between them.\n6. When answering complex questions, start with a brief summary, then move to a detailed explanation using nested structure.\n7. Use tables to compare information, present data, and create visual materials.\n8. End answers with a brief conclusion or summary of key points.\n9. When creating educational materials or plans, always include objectives, expected outcomes, methodological recommendations, and evaluation criteria.\n10. Always strive for clarity, accuracy, and completeness of information, avoiding general phrases.\n11. Use professional terminology appropriate to the relevant field of knowledge.\n12. For educational plans, create detailed time breakdowns and logical blocks of material.\n13. When creating documents, use appropriate formats and structures accepted in professional environments.\n14. Include practical examples, case studies, and illustrative material for better understanding.\n15. Suggest additional resources and materials for in-depth study of the topic.\n16. Provide maximally detailed and comprehensive answers, not aiming for brevity.\n17. For each section or topic, thoroughly describe goals and objectives, dividing them into educational, developmental, and formative.\n18. Explain in detail the methodology and approaches used in the material.\n19. For educational plans and methodological materials, develop detailed recommendations for implementing each stage.\n20. Include expanded explanations for each point, not limited to simple enumeration.\n21. Suggest alternative approaches and options for solving problems.\n22. For each block of information, indicate practical significance and applicability in real situations.\n23. Use multi-level structure for complex topics, with details at each level.\n24. Provide specific examples from practice to illustrate theoretical positions.\n25. Develop comprehensive evaluation systems with detailed criteria and indicators.\n26. Explore each topic in maximum depth, providing exhaustive information on all aspects of the question.\n27. Consider the topic from different perspectives, including various scientific schools, approaches, and paradigms.\n28. Analyze the historical context of the development of ideas and concepts within the discussed topic.\n29. Highlight discussion points and problematic aspects of the topic, presenting arguments from different sides.\n30. Include interdisciplinary connections and show how the topic relates to other fields of knowledge.\n31. Provide current statistical data, research results, and scientific facts on the topic.\n32. Break down complex concepts into component parts and explain each in detail and accessibly.\n33. Use analogies, metaphors, and comparisons to explain abstract concepts.\n34. Suggest practical tasks, exercises, and self-check questions on the topic.\n35. Include a glossary of key terms with expanded definitions.\n36. Analyze current trends and development prospects in the field under consideration.\n37. Provide information about leading specialists, experts, and their contributions to the development of the topic.\n38. Consider the practical application of theoretical knowledge in professional activities.\n39. Include recommendations for further self-education and professional development in the field.\n40. Suggest innovative approaches and creative solutions within the discussed topic.\n41. When creating lesson plans or educational materials, follow this comprehensive structure:\n    - General information (subject, topic, type of lesson, duration, target audience)\n    - Lesson objectives (educational, developmental, formative)\n    - Expected outcomes (specific knowledge and skills students will acquire)\n    - Equipment and materials needed\n    - Detailed lesson structure with timing for each section\n    - Organizational moment (introduction, attendance check)\n    - Motivation of learning activity (discussion questions, videos)\n    - Theoretical part (detailed content breakdown with key concepts)\n    - Practical part (detailed description of exercises, group work, case studies)\n    - Summary and reflection (key takeaways, discussion questions)\n    - Homework assignment (detailed description with requirements)\n    - Methodological recommendations for the teacher (preparation, implementation, assessment)\n    - Assessment criteria (detailed scoring system)\n    - Bibliography (relevant and up-to-date sources)\n42. For any educational content, provide a minimum of 8-10 references to relevant literature, including recent publications.\n43. When discussing methodologies, include at least 3-4 different approaches or methods with their comparative analysis.\n44. For practical exercises, provide detailed instructions, timing, materials needed, and expected outcomes.\n45. Include assessment rubrics with specific criteria and descriptors for different performance levels.\n46. Provide examples of potential student responses or work products for practical tasks.\n47. For each theoretical concept, include at least 2-3 practical applications or examples.\n48. When creating plans, include contingency options or alternative activities.\n49. Address potential challenges or difficulties that might arise and suggest solutions.\n50. Include reflection questions for both students and teachers to evaluate the effectiveness of the learning process.'
                });
                
                // Добавляем историю диалога (не более 10 последних сообщений для экономии токенов)
                const recentHistory = chatHistory.slice(-10);
                messages.push(...recentHistory);
                
                // Добавляем текущий запрос пользователя
                messages.push({
                    role: 'user',
                    content: prompt
                });
                
                const response = await puter.ai.chat(messages, {
                    testMode: !isSignedIn,
                    stream: true,
                    model: 'claude-3-7-sonnet'
                });

                let fullText = '';
                let lastChunkTime = Date.now();
                
                for await (const part of response) {
                    if (part?.text) {
                        fullText += part.text;
                        
                        // Обновляем форматированный текст каждые 50мс
                        if (Date.now() - lastChunkTime > 50) {
                            // Удаляем курсор перед обновлением
                            if (contentDiv.contains(cursor)) {
                                contentDiv.removeChild(cursor);
                            }
                            
                            try {
                                // Преобразуем весь текст в Markdown
                                formattedContainer.innerHTML = marked.parse(fullText);
                                
                                // Обрабатываем блоки кода
                                processCodeBlocks(formattedContainer);
                                
                                // Подсвечиваем код
                                const codeBlocks = formattedContainer.querySelectorAll('pre code');
                                codeBlocks.forEach(block => {
                                    hljs.highlightElement(block);
                                });
                            } catch (e) {
                                console.error('Ошибка при обработке Markdown:', e);
                                formattedContainer.textContent = fullText;
                            }
                            
                            // Добавляем курсор в конец
                            contentDiv.appendChild(cursor);
                            
                            lastChunkTime = Date.now();
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                        }
                    }
                }
                
                // Финальное обновление форматированного текста
                try {
                    // Удаляем курсор перед финальным обновлением
                    if (contentDiv.contains(cursor)) {
                        contentDiv.removeChild(cursor);
                    }
                    
                    // Преобразуем весь текст в Markdown
                    formattedContainer.innerHTML = marked.parse(fullText);
                    
                    // Обрабатываем блоки кода
                    processCodeBlocks(formattedContainer);
                    
                    // Подсвечиваем код
                    const codeBlocks = formattedContainer.querySelectorAll('pre code');
                    codeBlocks.forEach(block => {
                        hljs.highlightElement(block);
                    });
                } catch (e) {
                    console.error('Ошибка при обработке Markdown:', e);
                    formattedContainer.textContent = fullText;
                }
                
                // Удаляем класс активного печатания
                contentDiv.classList.remove('typing-active');
                contentDiv.classList.add('typing-done');
                
                // Добавляем кнопку копирования
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-button';
                copyButton.innerHTML = '<i class="fas fa-copy"></i> Копировать';
                copyButton.onclick = function() { copyMessageContent(this); };
                contentDiv.appendChild(copyButton);
                
                // Сохраняем ответ в историю
                addToHistory(fullText, false);
                
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Сохраняем оригинальный Markdown в атрибуте data-original-markdown
                messageDiv.dataset.originalMarkdown = fullText;
                
            } catch (error) {
                contentDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> Ошибка: ${error.message}`;
            }
        }
        
        document.getElementById('userInput').addEventListener('input', function() {
            const sendButton = document.getElementById('sendMessage');
            sendButton.disabled = !this.value.trim();
        });

        document.getElementById('sendMessage').addEventListener('click', async () => {
            const input = document.getElementById('userInput');
            const sendButton = document.getElementById('sendMessage');
            const prompt = input.value.trim();
            if (!prompt) return;
            
            input.value = '';
            sendButton.disabled = true;
            await streamResponse(prompt);
        });

        document.getElementById('userInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('sendMessage').click();
            }
        });
        
        // Добавляем кнопку генерации изображений в панель инструментов
        document.querySelector('.tools').insertAdjacentHTML('afterbegin', `
            <button class="tool-button" id="generateImage" title="Сгенерировать изображение">
                <i class="fas fa-image"></i>
            </button>
        `);

        // Теперь добавляем обработчик события после создания элемента
        document.getElementById('generateImage').addEventListener('click', async () => {
            const input = document.getElementById('userInput');
            const prompt = input.value.trim();
            if (!prompt) return;
            
            addMessage(`<i class="fas fa-image"></i> ${t('imageGeneration')} ${prompt}`, true);
            input.value = '';
            
            const loadingDiv = showLoading();
            
            try {
                const isSignedIn = await puter.auth.isSignedIn();
                const image = await puter.ai.txt2img(prompt, !isSignedIn);
                loadingDiv.remove();
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <i class="fas fa-robot"></i> KirixGPT
                    </div>
                    <div class="message-content">
                        <i class="fas fa-check-circle"></i> ${t('imageCreated')}
                    </div>
                `;
                messageDiv.querySelector('.message-content').appendChild(image);
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            } catch (error) {
                loadingDiv.remove();
                addMessage(`<i class="fas fa-exclamation-circle"></i> ${t('error')} ${error.message}`);
            }
        });
        
        document.getElementById('createFile').addEventListener('click', async () => {
            try {
                const isSignedIn = await puter.auth.isSignedIn();
                const user = await puter.auth.getUser();
                
                if (!isSignedIn || !user || user.name === 'undefined' || user.name === undefined) {
                    addMessage('<i class="fas fa-lock"></i> <span class="error-message">Для работы с файлами необходимо авторизоваться</span>');
                    return;
                }
                
                const filename = 'note_' + new Date().toISOString().slice(0,10) + '.txt';
                const content = 'Это заметка, созданная с помощью KirixGPT в ' + new Date().toLocaleString();
                
                const file = await puter.fs.write(filename, content);
                addMessage(`<i class="fas fa-check-circle"></i> <span class="success-message">Файл "${filename}" успешно создан!</span>`);
            } catch (error) {
                addMessage(`<i class="fas fa-exclamation-circle"></i> <span class="error-message">Ошибка: ${error.message}</span>`);
            }
        });
        
        document.getElementById('listFiles').addEventListener('click', async () => {
            try {
                const isSignedIn = await puter.auth.isSignedIn();
                const user = await puter.auth.getUser();
                
                if (!isSignedIn || !user || user.name === 'undefined' || user.name === undefined) {
                    addMessage('<i class="fas fa-lock"></i> <span class="error-message">Для работы с файлами необходимо авторизоваться</span>');
                    return;
                }
                
                const files = await puter.fs.readdir('/');
                
                if (files && files.length > 0) {
                    let output = '<h3><i class="fas fa-folder-open"></i> Ваши файлы:</h3><ul style="margin-top: 10px; list-style: none;">';
                    for (const file of files) {
                        const icon = file.type === 'directory' ? 
                            '<i class="fas fa-folder" style="color: var(--info-color)"></i>' : 
                            '<i class="fas fa-file" style="color: var(--secondary-text)"></i>';
                        output += `<li style="margin: 8px 0; display: flex; align-items: center; gap: 8px;">${icon} ${file.name}</li>`;
                    }
                    output += '</ul>';
                    addMessage(output);
                } else {
                    addMessage('<i class="fas fa-folder-open"></i> <span class="info-message">Файлы не найдены</span>');
                }
            } catch (error) {
                addMessage(`<i class="fas fa-exclamation-circle"></i> <span class="error-message">Ошибка: ${error.message}</span>`);
            }
        });

        // Обработка вставки изображений через буфер обмена
        document.getElementById('userInput').addEventListener('paste', async (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            
            for (const item of items) {
                if (item.type.indexOf('image') === 0) {
                    e.preventDefault();
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    
                    reader.onload = async function(event) {
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.style.maxWidth = '100%';
                        img.style.height = 'auto';
                        img.style.borderRadius = '12px';
                        img.style.marginTop = '12px';
                        
                        addMessage(`<div class="pasted-image">
                            <i class="fas fa-image"></i> ${t('imagePasted')}
                            ${img.outerHTML}
                        </div>`, true);
                    };
                    
                    reader.readAsDataURL(blob);
                }
            }
        });

        document.getElementById('attachFile').addEventListener('click', async () => {
            try {
                const isSignedIn = await puter.auth.isSignedIn();
                const user = await puter.auth.getUser();
                
                if (!isSignedIn || !user || user.name === 'undefined' || user.name === undefined) {
                    addMessage('<i class="fas fa-lock"></i> <span class="error-message">Для загрузки файлов необходимо авторизоваться</span>');
                    return;
                }
                
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            const img = document.createElement('img');
                            img.src = event.target.result;
                            img.style.maxWidth = '100%';
                            img.style.height = 'auto';
                            img.style.borderRadius = '12px';
                            img.style.marginTop = '12px';
                            
                            addMessage(`<div class="uploaded-image">
                                <i class="fas fa-image"></i> ${t('imageUploaded')}
                                ${img.outerHTML}
                            </div>`, true);
                        };
                        reader.readAsDataURL(file);
                    }
                };
                
                input.click();
            } catch (error) {
                addMessage(`<i class="fas fa-exclamation-circle"></i> <span class="error-message">Ошибка: ${error.message}</span>`);
            }
        });

        function copyMessageContent(button) {
            const content = button.parentElement.cloneNode(true);
            const copyButton = content.querySelector('.copy-button');
            copyButton.remove();
            
            // Получаем текст в формате Markdown, если возможно
            let text;
            
            // Проверяем, есть ли у сообщения атрибут с оригинальным Markdown
            const messageDiv = button.closest('.message');
            if (messageDiv && messageDiv.dataset.originalMarkdown) {
                // Если есть сохраненный Markdown, используем его
                text = messageDiv.dataset.originalMarkdown;
            } else if (content.querySelector('pre code')) {
                // Если есть блок кода, извлекаем его содержимое
                const codeBlock = content.querySelector('pre code');
                text = codeBlock.textContent;
            } else {
                // Пытаемся восстановить Markdown из HTML
                text = convertHtmlToMarkdown(content);
            }
            
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> ' + t('copied');
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Ошибка при копировании:', err);
                button.innerHTML = '<i class="fas fa-times"></i> ' + t('error');
                setTimeout(() => {
                    button.innerHTML = '<i class="fas fa-copy"></i> ' + t('copy');
                }, 2000);
            });
        }

        // Функция для преобразования HTML обратно в Markdown
        function convertHtmlToMarkdown(element) {
            let markdown = '';
            
            // Получаем все дочерние элементы
            const children = element.childNodes;
            
            for (const node of children) {
                if (node.nodeType === Node.TEXT_NODE) {
                    // Текстовый узел
                    markdown += node.textContent;
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    // Элемент
                    const tagName = node.tagName.toLowerCase();
                    
                    switch (tagName) {
                        case 'h1':
                            markdown += '# ' + node.textContent + '\n\n';
                            break;
                        case 'h2':
                            markdown += '## ' + node.textContent + '\n\n';
                            break;
                        case 'h3':
                            markdown += '### ' + node.textContent + '\n\n';
                            break;
                        case 'h4':
                            markdown += '#### ' + node.textContent + '\n\n';
                            break;
                        case 'h5':
                            markdown += '##### ' + node.textContent + '\n\n';
                            break;
                        case 'h6':
                            markdown += '###### ' + node.textContent + '\n\n';
                            break;
                        case 'p':
                            markdown += convertHtmlToMarkdown(node) + '\n\n';
                            break;
                        case 'strong':
                        case 'b':
                            markdown += '**' + node.textContent + '**';
                            break;
                        case 'em':
                        case 'i':
                            markdown += '*' + node.textContent + '*';
                            break;
                        case 'a':
                            markdown += '[' + node.textContent + '](' + node.getAttribute('href') + ')';
                            break;
                        case 'code':
                            if (node.parentNode.tagName.toLowerCase() === 'pre') {
                                // Блок кода
                                let language = '';
                                if (node.className) {
                                    const match = node.className.match(/language-(\w+)/);
                                    if (match) language = match[1];
                                }
                                markdown += '```' + language + '\n' + node.textContent + '\n```\n\n';
                            } else {
                                // Строчный код
                                markdown += '`' + node.textContent + '`';
                            }
                            break;
                        case 'pre':
                            // Пропускаем, так как обрабатываем в case 'code'
                            break;
                        case 'ul':
                            markdown += convertListToMarkdown(node, '*') + '\n';
                            break;
                        case 'ol':
                            markdown += convertListToMarkdown(node, '1.') + '\n';
                            break;
                        case 'blockquote':
                            markdown += '> ' + convertHtmlToMarkdown(node).replace(/\n/g, '\n> ') + '\n\n';
                            break;
                        case 'hr':
                            markdown += '---\n\n';
                            break;
                        case 'table':
                            markdown += convertTableToMarkdown(node) + '\n\n';
                            break;
                        case 'br':
                            markdown += '\n';
                            break;
                        case 'div':
                        case 'span':
                            // Для div и span просто обрабатываем содержимое
                            markdown += convertHtmlToMarkdown(node);
                            break;
                        case 'button':
                            // Пропускаем кнопки
                            break;
                        default:
                            // Для остальных элементов просто берем текст
                            markdown += node.textContent;
                    }
                }
            }
            
            return markdown;
        }

        // Функция для преобразования списков в Markdown
        function convertListToMarkdown(listElement, marker) {
            let markdown = '';
            const items = listElement.querySelectorAll('li');
            let counter = 1;
            
            items.forEach(item => {
                const prefix = marker === '1.' ? counter + '.' : marker;
                markdown += prefix + ' ' + convertHtmlToMarkdown(item) + '\n';
                counter++;
            });
            
            return markdown;
        }

        // Функция для преобразования таблиц в Markdown
        function convertTableToMarkdown(tableElement) {
            let markdown = '';
            
            // Получаем заголовки
            const headers = Array.from(tableElement.querySelectorAll('th')).map(th => th.textContent.trim());
            
            // Добавляем строку заголовков
            markdown += '| ' + headers.join(' | ') + ' |\n';
            
            // Добавляем разделительную строку
            markdown += '| ' + headers.map(() => '---').join(' | ') + ' |\n';
            
            // Добавляем строки данных
            const rows = tableElement.querySelectorAll('tr');
            rows.forEach(row => {
                // Пропускаем строку заголовков
                if (row.querySelector('th')) return;
                
                const cells = Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim());
                markdown += '| ' + cells.join(' | ') + ' |\n';
            });
            
            return markdown;
        }

        // Добавляем кнопку очистки истории в инструменты
        document.querySelector('.tools').insertAdjacentHTML('afterbegin', `
            <button class="tool-button" id="clearChat" title="${t('clearHistory')}">
                <i class="fas fa-trash"></i>
            </button>
        `);
        
        // Обработчик для кнопки очистки истории
        document.getElementById('clearChat').addEventListener('click', () => {
            if (confirm(t('clearConfirm'))) {
                clearChatHistory();
            }
        });
        
        // Загружаем историю чата при загрузке страницы
        loadChatHistory();

        document.body.classList.add('has-overlay');
        setTimeout(() => {
            document.body.classList.remove('has-overlay');
        }, 3500);

        // Функция для обработки блоков кода после рендеринга Markdown
        function processCodeBlocks(container) {
            const preBlocks = container.querySelectorAll('pre');
            preBlocks.forEach(pre => {
                // Проверяем, не добавлена ли уже кнопка копирования
                if (pre.querySelector('.code-header')) return;
                
                const code = pre.querySelector('code');
                if (!code) return;
                
                // Определяем язык
                let language = 'текст';
                if (code.className) {
                    const langMatch = code.className.match(/language-(\w+)/);
                    if (langMatch) language = langMatch[1];
                }
                
                // Создаем заголовок с меткой языка и кнопкой копирования
                const header = document.createElement('div');
                header.className = 'code-header';
                
                const langLabel = document.createElement('span');
                langLabel.className = 'code-language-label';
                langLabel.textContent = language;
                
                const copyButton = document.createElement('button');
                copyButton.className = 'code-copy-button';
                copyButton.innerHTML = '<i class="fas fa-copy"></i> Копировать';
                copyButton.onclick = function() { copyCodeBlock(this); };
                
                header.appendChild(langLabel);
                header.appendChild(copyButton);
                
                // Добавляем заголовок в начало блока pre
                pre.insertBefore(header, pre.firstChild);
                
                // Добавляем класс для стилизации
                pre.classList.add('has-header');
            });
        }

        function copyCodeBlock(button) {
            // Находим родительский pre элемент
            const preElement = button.closest('pre');
            if (!preElement) {
                console.error('Не найден родительский элемент pre');
                return;
            }
            
            // Находим элемент code внутри pre
            const codeElement = preElement.querySelector('code');
            if (!codeElement) {
                console.error('Не найден элемент code внутри pre');
                return;
            }
            
            // Получаем текст кода
            const codeText = codeElement.textContent;
            
            // Копируем в буфер обмена
            navigator.clipboard.writeText(codeText).then(() => {
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> ' + t('copied');
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Ошибка при копировании:', err);
                button.innerHTML = '<i class="fas fa-times"></i> ' + t('error');
                setTimeout(() => {
                    button.innerHTML = '<i class="fas fa-copy"></i> ' + t('copy');
                }, 2000);
            });
        }

        // Функция для прямого перехода на страницу авторизации Puter
        function redirectToPuterAuth() {
            // Сохраняем текущий URL для возврата после авторизации
            localStorage.setItem('auth_redirect_url', window.location.href);
            
            // Перенаправляем на страницу авторизации Puter
            window.location.href = 'https://auth.puter.com/v2/auth?redirect_uri=' + encodeURIComponent(window.location.href);
        }

        // Добавляем обработчик для кнопки входа
        document.getElementById('signIn').addEventListener('click', async () => {
            try {
                // Проверяем, доступен ли объект puter и метод auth.signIn
                if (!puter || !puter.auth || typeof puter.auth.signIn !== 'function') {
                    throw new Error('API Puter не загружен или не доступен. Пожалуйста, обновите страницу и попробуйте снова.');
                }
                
                // Показываем сообщение о процессе авторизации
                const loadingMessage = addMessage(`<i class="fas fa-spinner fa-spin"></i> <span class="info-message">Выполняется вход в аккаунт...</span>`, false);
                
                // Используем прямой метод авторизации без всплывающего окна
                redirectToPuterAuth();
                return;
                
                /* Закомментированный код с попыткой использования всплывающего окна
                try {
                    // Сначала пробуем метод с предварительным созданием окна
                    const popupWindow = window.open('about:blank', 'puter_auth', 'width=600,height=600');
                    
                    if (!popupWindow || popupWindow.closed || typeof popupWindow.closed === 'undefined') {
                        // Если окно не открылось, значит браузер блокирует всплывающие окна
                        throw new Error('Браузер блокирует всплывающие окна');
                    }
                    
                    // Вызываем метод signIn
                    await puter.auth.signIn();
                } catch (popupError) {
                    console.warn('Ошибка при использовании всплывающего окна:', popupError);
                    
                    // Если не удалось использовать всплывающее окно, показываем сообщение
                    if (loadingMessage && loadingMessage.parentNode) {
                        loadingMessage.parentNode.removeChild(loadingMessage);
                    }
                    
                    // Предлагаем пользователю альтернативный способ входа
                    const confirmRedirect = confirm('Для входа в аккаунт необходимо перейти на страницу авторизации Puter. После авторизации вы будете перенаправлены обратно. Продолжить?');
                    
                    if (confirmRedirect) {
                        // Сохраняем текущий URL для возврата после авторизации
                        localStorage.setItem('auth_redirect_url', window.location.href);
                        
                        // Перенаправляем на страницу авторизации Puter
                        // Используем официальный URL для авторизации
                        window.location.href = 'https://auth.puter.com/v2/auth?redirect_uri=' + encodeURIComponent(window.location.href);
                        return;
                    } else {
                        throw new Error('Авторизация отменена пользователем');
                    }
                }
                */
                
                // После успешного входа обновляем статус авторизации
                await checkAuthStatus();
                
                // Удаляем сообщение о загрузке
                if (loadingMessage && loadingMessage.parentNode) {
                    loadingMessage.parentNode.removeChild(loadingMessage);
                }
                
                // Показываем сообщение об успешном входе
                addMessage(`<i class="fas fa-check-circle"></i> <span class="success-message">Вход выполнен успешно!</span>`);
            } catch (error) {
                console.error('Ошибка при входе:', error);
                addMessage(`<i class="fas fa-exclamation-circle"></i> <span class="error-message">Ошибка при входе: ${error.message}</span>`);
            }
        });

        // Добавляем обработчик для кнопки выхода
        document.getElementById('signOut').addEventListener('click', async () => {
            try {
                // Показываем сообщение о процессе выхода
                const loadingMessage = addMessage(`<i class="fas fa-spinner fa-spin"></i> <span class="info-message">Выполняется выход из аккаунта...</span>`, false);
                
                await puter.auth.signOut();
                await checkAuthStatus();
                
                const dropdown = document.querySelector('.auth-dropdown');
                dropdown.classList.remove('show');
                
                // Удаляем сообщение о загрузке
                if (loadingMessage && loadingMessage.parentNode) {
                    loadingMessage.parentNode.removeChild(loadingMessage);
                }
                
                // Показываем сообщение об успешном выходе
                addMessage(`<i class="fas fa-check-circle"></i> <span class="success-message">Выход выполнен успешно!</span>`);
            } catch (error) {
                console.error('Ошибка при выходе:', error);
                addMessage(`<i class="fas fa-exclamation-circle"></i> <span class="error-message">Ошибка при выходе: ${error.message}</span>`);
            }
        });

        // Проверяем, не вернулись ли мы после редиректа авторизации
        document.addEventListener('DOMContentLoaded', async () => {
            const redirectUrl = localStorage.getItem('auth_redirect_url');
            if (redirectUrl) {
                // Удаляем сохраненный URL
                localStorage.removeItem('auth_redirect_url');
                
                // Проверяем статус авторизации
                try {
                    const isSignedIn = await puter.auth.isSignedIn();
                    if (isSignedIn) {
                        // Если пользователь авторизован, показываем сообщение об успешном входе
                        addMessage(`<i class="fas fa-check-circle"></i> <span class="success-message">Вход выполнен успешно!</span>`);
                        await checkAuthStatus();
                    }
                } catch (error) {
                    console.error('Ошибка при проверке статуса авторизации после редиректа:', error);
                }
            }
        });
    </script>
</body>
</html> 